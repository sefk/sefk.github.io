<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Posts about personal-tech | sef.kloninger.com</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://sef.kloninger.com/categories/cat_personal-tech/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><link rel="alternate" type="application/rss+xml" title="RSS for category personal-tech" hreflang="en" href="../cat_personal-tech.xml">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">

            <span id="blog-title">sef.kloninger.com</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../posts/" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="mailto:sefklon@gmail.com" class="nav-link">Email</a>
                </li>
<li class="nav-item">
<a rel="me" href="https://hachyderm.io/@sefk" class="nav-link">Mastodon</a>
                </li>
<li class="nav-item">
<a href="https://bsky.app/profile/sefk.bsky.social" class="nav-link">Bsky</a>
                </li>
<li class="nav-item">
<a href="https://twitter.com/sefk" class="nav-link">X</a>
                </li>
<li class="nav-item">
<a href="https://www.linkedin.com/in/sefkloninger/" class="nav-link">LinkedIn</a>
                </li>
<li class="nav-item">
<a href="https://github.com/sefk" class="nav-link">GitHub</a>
                </li>
<li class="nav-item">
<a href="https://rawgithub.com/sefk/sef-resume/master/sef-kloninger-resume.html" class="nav-link">Resume</a>
                </li>
<li class="nav-item">
<a href="https://rawgithub.com/sefk/sef-resume/master/sef-kloninger-resume.pdf" class="nav-link">PDF</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        

    <header><h1>Posts about personal-tech</h1>
        <div class="metadata">
            
                <p class="feedlink">
                        
            <a href="../cat_personal-tech.xml" hreflang="en" type="application/rss+xml">RSS feed</a>

                </p>

            

        </div>
    </header><div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../../posts/photo-dups/" class="u-url">Cleaning Up Photo Duplicates</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Sef Kloninger
            </span></p>
            <p class="dateline">
            <a href="../../posts/photo-dups/" rel="bookmark">
            <time class="published dt-published" datetime="2024-02-19T12:00:00-08:00" itemprop="datePublished" title="2024-02-19 12:00">2024-02-19 12:00</time></a>
            </p>
                <p class="commentline">
    
    <a href="../../posts/photo-dups/#disqus_thread" data-disqus-identifier="cache/posts/dups.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p><img style="float:right" class="postimage" src="../../f/dups-pie.png" alt="Pie Chart" width="30%"></p>
<p>I did a data cleanup over the weekend. I doubt this is interesting
for anyone else, I just wanted to capture my own notes.</p>
<p>Our family photos are stored up in Google Photos. We have about
100k photos and short movies that take up 0.5TB. I wanted to back
up to <a href="https://www.synology.com/en-us/products?product_line=ds_plus">local storage</a>, but also I liked the idea of trying the
<a href="https://www.mdisc.com/">mdisc</a> format for long-term storage.</p>
<p>I ran <a href="https://takeout.google.com/">Takeout</a> and unzipped everything. I was surprised to see
so many duplicates. Some are copies in the same folders with suffixes
like "(1)", most are multiple copies in different folders.
Takeout seems to just store a copy for each album a photo is in.</p>
<p><a href="https://docs.google.com/spreadsheets/d/10pRVc1_6u0G2z62uEJSHHZ0yzf43Zoa9yx0D2bpICmE/edit?usp=sharing">Some poking at the data</a> shows 88% of 302,755 files / 72% of
the bytes were unique (histogram at the bottom of the post).  Removing
dups can save 200+GB. Sure not really worth the trouble but why
not.</p>
<h4>Steps</h4>
<p>1. On the NAS, gather file checksums (<code>md5sum</code>) and sizes for all
the files under <code>Takeout/Google Files</code>. Mostly variations on
of <code>find -print0 | xargs -0</code>.</p>
<p>2. Data cleanup to get into nice file paths and clean delimiters,
mostly interactively with <code>vi</code>.</p>
<p>3. Insert into <code>sqlite</code> using <code>.separator</code> and <code>.import</code>.</p>
<p>Here's what the database ended up looking like: <code>Photos</code> and <code>Sizes</code>
are inputs, <code>HashCounts</code>, <code>Duplicates</code>, and <code>Candidates</code> are
outputs.</p>
<div class="code"><pre class="code literal-block"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Photos</span><span class="p">(</span><span class="n">hash</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="n">path</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Sizes</span><span class="p">(</span><span class="k">size</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="n">path</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">HashCounts</span><span class="p">(</span><span class="n">hash</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="k">found</span><span class="w"> </span><span class="nb">INT</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Duplicates</span><span class="p">(</span><span class="n">path</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="n">hash</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="k">found</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="k">size</span><span class="w"> </span><span class="nb">INT</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Candidates</span><span class="p">(</span><span class="n">path</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="n">hash</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="k">size</span><span class="w"> </span><span class="nb">INT</span><span class="p">,</span><span class="n">pos</span><span class="w"> </span><span class="nb">INT</span><span class="p">);</span>
</pre></div>

<p>4. Find the dups. I'm surprised to find some with 50 or more copies,
but it out some family favorites end up in lots of albums.</p>
<div class="code"><pre class="code literal-block"><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">HashCounts</span>
<span class="k">select</span><span class="w"> </span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">found</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Photos</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">hash</span><span class="p">;</span>
</pre></div>

<p>5. Figure out candidates for deletion</p>
<div class="code"><pre class="code literal-block"><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">Duplicates</span>
<span class="k">select</span><span class="w"> </span><span class="n">Photos</span><span class="p">.</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">Photos</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="n">HashCounts</span><span class="p">.</span><span class="k">found</span><span class="p">,</span><span class="w"> </span><span class="n">Sizes</span><span class="p">.</span><span class="k">size</span>
<span class="k">from</span><span class="w"> </span><span class="n">Photos</span><span class="p">,</span><span class="w"> </span><span class="n">HashCounts</span><span class="p">,</span><span class="w"> </span><span class="n">Sizes</span>
<span class="k">where</span><span class="w"> </span><span class="n">HashCounts</span><span class="p">.</span><span class="n">hash</span><span class="o">=</span><span class="n">Photos</span><span class="p">.</span><span class="n">hash</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">Photos</span><span class="p">.</span><span class="n">path</span><span class="o">=</span><span class="n">Sizes</span><span class="p">.</span><span class="n">path</span>
<span class="k">and</span><span class="w"> </span><span class="n">HashCounts</span><span class="p">.</span><span class="k">found</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</pre></div>

<p>The first of each set is the one we'll keep.</p>
<div class="code"><pre class="code literal-block"><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">Candidates</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="p">,</span><span class="w"> </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">hash</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">row_number</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Duplicates</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">hash</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="k">desc</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">row_number</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</pre></div>

<p>I was surprised that sqlplus supports window functions, nice.</p>
<p>The inner reverse-alpha sort on "path" takes care of two cases.
I tend to prefer keeping photos with names that start with
years, and Those come first alphabetically (nice). Also within
folders often there are many copies with "(1)" and "(2)" suffixes
that are generally cruft and most worthy of removing, and those
also sort last alphabetically (nice).</p>
<p>5. Dump out the "Candidates" using <code>.output</code>. Copy back to the NAS.
Do lots of spot checks. Convert to a bash script of <code>rm</code> commands,
run very carefully.</p>
<h4>Tools</h4>
<p><strong>Sqlite</strong> is my go-to tool for ad-hoc work like this.  It's fast
and simple, but only for small jobs -- this one is MB-scale.</p>
<div class="code"><pre class="code literal-block"><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">pgsize</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">dbstat</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="n">name</span><span class="w">           </span><span class="k">sum</span><span class="p">(</span><span class="n">pgsize</span><span class="p">)</span>
<span class="c1">-------------  -----------</span>
<span class="n">Candidates</span><span class="w">     </span><span class="mi">3006464</span>
<span class="n">Duplicates</span><span class="w">     </span><span class="mi">5541888</span>
<span class="n">HashCounts</span><span class="w">     </span><span class="mi">11051008</span>
<span class="n">Photos</span><span class="w">         </span><span class="mi">23240704</span>
<span class="n">Sizes</span><span class="w">          </span><span class="mi">13807616</span>
<span class="n">sqlite_schema</span><span class="w">  </span><span class="mi">4096</span>
</pre></div>

<p>My <strong>Synology</strong> is a pretty good place for storage with ability to
ssh in and run local commands.  But if I had to do this again,
though, I should have just bought a large locally-connected SSD.
All the transfers to-from the NAS were a hassle. Looking now I'm
stunned that you can get a 4 TB external SSD for under $300.</p>
<p>Some <a href="https://docs.google.com/spreadsheets/d/1O4gzeTn8GNeL1X4DrBUprcEqpK6jKbQrtEfBNdJF-Pw/edit#gid=810787524">private notes</a> here.</p>
<p><img class="postimage" src="../../f/dups-histo.png" alt="Histogram" width="100%">
(<a href="https://docs.google.com/spreadsheets/d/10pRVc1_6u0G2z62uEJSHHZ0yzf43Zoa9yx0D2bpICmE/edit?usp=sharing">source</a>)</p>
    </div>
    </article>
</div>



    
       <script>var disqus_shortname="sefkloninger";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer"><p align="center">Contents © 2025 <a href="mailto:sefklon@gmail.com">Sef Kloninger</a>       
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/us/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/2.5/ar/88x31.png"></a></p>
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script src="../../assets/js/luxon.min.js"></script><!-- fancy dates --><script>
        luxon.Settings.defaultLocale = "en";
        fancydates(2, {"preset": false, "format": "yyyy-MM-dd HH:mm"});
        </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-30366531-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-30366531-1');
</script>
</body>
</html>
